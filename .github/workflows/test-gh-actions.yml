# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the workflow will run
on:

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:

  job1:
    runs-on: ubuntu-latest
    continue-on-error: true
    environment: dev
    outputs:
      real_result: ${{ steps.set_result.outputs.result }}

    steps:
      - name: Run job1 logic
        id: run_step
        run: |
          echo "Running job1"
          # Cambia esto por tu lógica real
          exit 0
        continue-on-error: true

      - name: Set real result
        id: set_result
        run: |
          if [[ "${{ steps.run_step.outcome }}" == "failure" ]]; then
            echo "result=failure" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.run_step.outcome }}" == "cancelled" ]]; then
            echo "result=cancelled" >> $GITHUB_OUTPUT
          else
            echo "result=success" >> $GITHUB_OUTPUT
          fi


  job2:
    runs-on: ubuntu-latest
    continue-on-error: true
    environment: qa
    outputs:
      real_result: ${{ steps.set_result.outputs.result }}

    steps:
      - name: Run job2 logic
        id: run_step
        run: |
          echo "Running job2"
          exit 1   # Simulamos fallo
        continue-on-error: true

      - name: Set real result
        id: set_result
        run: |
          if [[ "${{ steps.run_step.outcome }}" == "failure" ]]; then
            echo "result=failure" >> $GITHUB_OUTPUT
          elif [[ "${{ steps.run_step.outcome }}" == "cancelled" ]]; then
            echo "result=cancelled" >> $GITHUB_OUTPUT
          else
            echo "result=success" >> $GITHUB_OUTPUT
          fi


  job3:
    runs-on: ubuntu-latest
    if: always()
    needs: [job1, job2]

    steps:
      - name: Evaluate results
        run: |
          echo "job1 result: ${{ needs.job1.result }}"
          echo "job2 result: ${{ needs.job2.result }}"

          if [[ "${{ needs.job1.result }}" == "failure" || \
                "${{ needs.job2.result }}" == "failure" ]]; then
            echo "At least one job failed → PIPELINE FAIL"
            exit 1
          fi

          echo "No failures detected → PIPELINE SUCCESS"
